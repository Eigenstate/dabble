#!/bin/csh
#

# Generated by CHARMM-GUI (http://www.charmm-gui.org) v1.6

# This folder contains GROMACS formatted CHARMM36 force fields, a pre-optimized PDB structure, and GROMACS inputs.
# All input files were optimized for GROMACS v5.0 or above, so lower version of GROMACS can cause some errors.
# We adopted the Verlet cut-off scheme for all minimization, equilibration, and production steps because it is 
# faster and more accurate than the group scheme. If you have a trouble with a performance of Verlet scheme while 
# running parallelized simulation, you should check if you are using appropriate command line.
# For MPI parallelizing, we recommand following command:
# mpirun -np $NUM_CPU gmx mdrun -ntomp 1


# Minimization
# In the case that there is a problem during minimization using a single precision of GROMACS, please try to use 
# a double precision of GROMACS only for the minimization step.

# step6.0
gmx grompp -f step6.0_minimization.mdp -o step6.0_minimization.tpr -c step5_charmm2gmx.pdb -p topol.top
gmx_d mdrun -v -deffnm step6.0_minimization

# Equilibration
# step6.1
gmx grompp -f step6.1_equilibration.mdp -o step6.1_equilibration.tpr -c step6.0_minimization.gro -r step5_charmm2gmx.pdb -n index.ndx -p topol.top
gmx mdrun -v -deffnm step6.1_equilibration
# step6.2
gmx grompp -f step6.2_equilibration.mdp -o step6.2_equilibration.tpr -c step6.1_equilibration.gro -r step5_charmm2gmx.pdb -n index.ndx -p topol.top
gmx mdrun -v -deffnm step6.2_equilibration
# step6.3
gmx grompp -f step6.3_equilibration.mdp -o step6.3_equilibration.tpr -c step6.2_equilibration.gro -r step5_charmm2gmx.pdb -n index.ndx -p topol.top
gmx mdrun -v -deffnm step6.3_equilibration
# step6.4
gmx grompp -f step6.4_equilibration.mdp -o step6.4_equilibration.tpr -c step6.3_equilibration.gro -r step5_charmm2gmx.pdb -n index.ndx -p topol.top
gmx mdrun -v -deffnm step6.4_equilibration
# step6.5
gmx grompp -f step6.5_equilibration.mdp -o step6.5_equilibration.tpr -c step6.4_equilibration.gro -r step5_charmm2gmx.pdb -n index.ndx -p topol.top
gmx mdrun -v -deffnm step6.5_equilibration
# step6.6
gmx grompp -f step6.6_equilibration.mdp -o step6.6_equilibration.tpr -c step6.5_equilibration.gro -r step5_charmm2gmx.pdb -n index.ndx -p topol.top
gmx mdrun -v -deffnm step6.6_equilibration

# Production
set cnt    = 1
set cntmax = 10

while ( ${cnt} <= ${cntmax} )
	if ( ${cnt} == 1 ) then
		gmx grompp -f step7_production.mdp -o step7_${cnt}.tpr -c step6.6_equilibration.gro -n index.ndx -p topol.top
		gmx mdrun -v -deffnm step7_${cnt}
	else
		@ pcnt = ${cnt} - 1
		gmx convert-tpr -s step7_${pcnt}.tpr -f step7_${pcnt}.trr -e step7_${pcnt}.edr -o step7_${cnt}.tpr -extend 1000
		gmx mdrun -v -deffnm step7_${cnt}
	endif
	@ cnt += 1
end

