* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) VERSION on Jan, 12. 2015.
* ASSEMBLE PREVIOUSLY GENERATED COMPONENTS (LIPID BILAYER, PROTEIN, PORE WATER, WATER, AND ION)
* 
 
DIMENS CHSIZE 2000000
!DIMENS CHSIZE 1000000

! Read topology and parameter files
stream toppar.str

!Read the system information
stream step3_size.str
stream step4_components.str

! Read Lipids
open read card unit 10 name step4_lipid_lipid.crd
read sequence coor card unit 10
generate MEMB warn first none last none 
open read unit 10 card name step4_lipid_lipid.crd
read coor unit 10 card resid

if nwater .gt. 0 then
read sequence TIP3 @nwater
generate TIP3 warn noangle nodihedral

open read unit 10 card name step4_lipid_water.crd
read coor unit 10 card resid
endif

define PTOT sele .not. hydrogen end

!
!Add water? 
!
open read card unit 10 name step4.2_waterbox.crd
read sequence coor card unit 10
generate W2 setup warn noangle nodihedral

open read unit 10 card name step4.2_waterbox.crd
read coor unit 10 card append

coor stat sele segid W2 end
calc zmove = @C / 2.0 
calc zzw2 = -?zmax + @zcen
calc zzw3 = -?zmin + @zcen

coor trans zdir  @zzw2  sele segid W2 end
coor trans zdir  @zmove sele segid W2 end

define junk sele .byres. ( ( segid W2 .and. type OH2 ) .and. -
                           ( PTOT .around. 2.8 ) ) end
if ?nsel .ne. 0 delete atom sele junk end
define junk sele .byres. ( ( segid W2 .and. type OH2 ) .and. -
                           ( prop Z .lt. 15 ) .and. ( prop Z .gt. -15 ) ) end
if ?nsel .ne. 0 delete atom sele junk end

define PTOT sele .not. hydrogen end

open read card unit 10 name step4.2_waterbox.crd
read sequence coor card unit 10
generate W3 setup warn noangle nodihedral

open read unit 10 card name step4.2_waterbox.crd
read coor unit 10 card append

coor trans zdir  @zzw3  sele segid W3 end
coor trans zdir -@zmove sele segid W3 end

define junk sele .byres. ( ( segid W3 .and. type OH2 ) .and. -
                           ( PTOT .around. 2.8 ) ) end
if ?nsel .ne. 0 delete atom sele junk end
define junk sele .byres. ( ( segid W3 .and. type OH2 ) .and. -
                           ( prop Z .lt. 15 ) .and. ( prop Z .gt. -15 ) ) end
if ?nsel .ne. 0 delete atom sele junk end

if nwater .ne. 0 then
   join TIP3 W2 renumber
else
   rename segid TIP3 sele segid W2 end
   join TIP3 renumber
endif
join TIP3 W3 renumber

!
! Add Ion?
!

stream step4.3_pos.prm

if npos .gt. 0 then
   open read card unit 10 name step4.3_pos.crd
   read sequence coor card unit 10
   generate @posid setup warn noangle nodihedral
   
   open read unit 10 card name step4.3_pos.crd
   read coor unit 10 card append
endif

if nneg .gt. 0 then
   open read card unit 10 name step4.3_neg.crd
   read sequence coor card unit 10
   generate @negid setup warn noangle nodihedral

   open read unit 10 card name step4.3_neg.crd
   read coor unit 10 card append
endif


!
! Short minimization
!

stream step5_assembly_minimization.str
crystal free

!
! Write PSF, coordinates, and information of the assembled system
!

open write unit 10 card name step5_assembly.psf
write psf  unit 10 card

open write unit 10 card name step5_assembly.oldpsf
write psf  unit 10 card oldpsf

open write unit 10 card name step5_assembly.pdb
write coor unit 10 pdb

open write unit 10 card name step5_assembly.crd
write coor unit 10 card

open write unit 10 card name step5_assembly.xplor_ext.psf
write psf  xplo unit 10 card

ioformat noext
open write unit 10 card name step5_assembly.xplor.psf
write psf  xplo unit 10 card

coor stat sele resname TIP3 .and. type OH2 end
set Nwater   = ?nsel

open write card  unit 51 name step5_assembly.str
write title unit 51
* set BOXtype  = @BOXtype
* set XTLtype  = @XTLtype
* set A        = @A
* set B        = @B
* set C        = @C
* set Alpha    = @Alpha
* set Beta     = @Beta
* set Gamma    = @Gamma
* set Zcen     = 0.0
* set NLIPTOP  = @nliptop
* set NLIPBOT  = @nlipbot
* set Nwater   = @Nwater
* set posid    = @posid
* set negid    = @negid
* set Npos     = @Npos
* set Nneg     = @Nneg
*

ioformat ext

system "cp */*.rtf toppar/"
system "cp */*.prm toppar/"

!
! For NAMD inputs
!
stream membrane_lipid_restraint.namd.str
stream membrane_lipid_restraint2.namd.str
system "mkdir -p namd/toppar"
system "python convert_par2namd.py toppar.str toppar/"

!
! For OpenMM inputs
!
stream step5_assembly.omm.str

!
! For GROMACS inputs
!
stream step5_assembly.gmx.str

stop