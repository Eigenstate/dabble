

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Dabble.builder &mdash; Dabble 1.0a1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Dabble 1.0a1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> Dabble</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../command_line.html">Command-line Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../command_line.html#the-protein">The protein</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../command_line.html#the-membrane-or-solvent">The membrane or solvent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../command_line.html#ions">Ions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../command_line.html#geometry-specification">Geometry specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../command_line.html#desired-output">Desired output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../command_line.html#less-common-options">Less common options</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../parameter_api.html">DabbleParam package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../parameter_api.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../parameter_api.html#dabbleparam-amber-module">DabbleParam.amber module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../parameter_api.html#dabbleparam-charmm-module">DabbleParam.charmm module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../parameter_api.html#module-contents">Module contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Dabble.html">Dabble package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../Dabble.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Dabble.html#module-Dabble.builder">Dabble.builder module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Dabble.html#module-Dabble.fileutils">Dabble.fileutils module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Dabble.html#module-Dabble.molutils">Dabble.molutils module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Dabble.html#module-Dabble">Module contents</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Dabble</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>Dabble.builder</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for Dabble.builder</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">System builder</span>

<span class="sd">Author: Robin Betz</span>

<span class="sd">Copyright (C) 2015 Robin Betz</span>

<span class="sd">This program is free software; you can redistribute it and/or modify it under</span>
<span class="sd">the terms of the GNU Lesser General Public License as published by the Free</span>
<span class="sd">Software Foundation; either version 2 of the License, or (at your option) any</span>
<span class="sd">later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<span class="sd">WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A</span>
<span class="sd">PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU Lesser General Public License along</span>
<span class="sd">with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="sd">59 Temple Place - Suite 330</span>
<span class="sd">Boston, MA 02111-1307, USA.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">resource_filename</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="c"># Pylint hates vmd</span>
<span class="c"># pylint: disable=import-error, unused-import</span>
<span class="kn">import</span> <span class="nn">vmd</span>
<span class="kn">import</span> <span class="nn">molecule</span>
<span class="kn">import</span> <span class="nn">trans</span>
<span class="kn">from</span> <span class="nn">atomsel</span> <span class="kn">import</span> <span class="n">atomsel</span>
<span class="c"># pylint: enable=import-error, unused-import</span>

<span class="kn">from</span> <span class="nn">Dabble</span> <span class="kn">import</span> <span class="n">fileutils</span>
<span class="kn">from</span> <span class="nn">Dabble</span> <span class="kn">import</span> <span class="n">molutils</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<span class="c"># Constants</span>
<span class="n">_MEMBRANE_HYDROPHOBIC_THICKNESS</span> <span class="o">=</span> <span class="mf">30.0</span>
<span class="n">_MEMBRANE_FULL_THICKNESS</span> <span class="o">=</span> <span class="mf">50.0</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<div class="viewcode-block" id="DabbleBuilder"><a class="viewcode-back" href="../../Dabble.html#Dabble.builder.DabbleBuilder">[docs]</a><span class="k">class</span> <span class="nc">DabbleBuilder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds protein systems, optionally in a membrane.</span>

<span class="sd">    Tiles box appropriately, inserts protein into box,</span>
<span class="sd">    removes conflicts, trims excess solvent and adds ions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">      molids (dict str-&gt;int): Molecule IDs comprising system components</span>
<span class="sd">      size (array len 3 of floats): Size of the x, y, and z dimensions of the system</span>
<span class="sd">      solute_sel (str): VMD atom selection string for original solute</span>
<span class="sd">      opts (dictionary): All options passed to the system builder</span>
<span class="sd">      tmp_dir (str): Directory in which to save temporary files</span>
<span class="sd">      water_only (bool): If the solvent is just a water box</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#==========================================================================</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2015</span><span class="p">)</span> <span class="c"># Be deterministic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">water_only</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmin</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tmp_dir&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tmp_dir&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;dabble&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

        <span class="c"># Check for default lipid membrane</span>
        <span class="c"># Set some default options</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;forcefield&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;forcefield&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;charmm&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;lipid_sel&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;lipid or resname POPS POPG&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;cation&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;cation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Na&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;salt_conc&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;salt_conc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.150</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;wat_buffer&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;wat_buffer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">20.0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;xy_buf&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;xy_buf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">17.5</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;lipid_dist&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;lipid_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.75</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;membrane_system&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;membrane_system&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">resource_filename</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> \
                    <span class="s">&quot;lipid_membranes/popc.mae&quot;</span><span class="p">)</span>

        <span class="c"># Process input arguments</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;membrane_system&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DEFAULT&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;membrane_system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> \
                    <span class="s">&quot;lipid_membranes/popc.mae&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;membrane_system&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;TIP3&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;membrane_system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> \
                    <span class="s">&quot;lipid_membranes/tip3pbox.mae&quot;</span><span class="p">)</span>


        <span class="c"># Check the file output format is supported</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_fmt</span> <span class="o">=</span> <span class="n">fileutils</span><span class="o">.</span><span class="n">check_out_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;output_filename&#39;</span><span class="p">),</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;forcefield&#39;</span><span class="p">),</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;hmassrepartition&#39;</span><span class="p">))</span>

    <span class="c">#==========================================================================</span>

    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds the system</span>

<span class="sd">        Returns:</span>
<span class="sd">         (int) VMD molecule id of built system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Load the membrane system, check if it&#39;s water only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_molecule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;membrane_system&#39;</span><span class="p">),</span> <span class="s">&#39;membrane&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">),</span> <span class="n">molid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;membrane&#39;</span><span class="p">])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">water_only</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;No lipid detected. Proceeding with pure liquid solvent&quot;</span><span class="p">)</span>
        <span class="n">x_mem</span><span class="p">,</span> <span class="n">y_mem</span><span class="p">,</span> <span class="n">z_mem</span> <span class="o">=</span> \
                <span class="n">molutils</span><span class="o">.</span><span class="n">get_system_dimensions</span><span class="p">(</span><span class="n">molid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;membrane&#39;</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Solvent patch dimensions are </span><span class="si">%.2f</span><span class="s"> x </span><span class="si">%.2f</span><span class="s"> x </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_mem</span><span class="p">,</span>
                                                                   <span class="n">y_mem</span><span class="p">,</span>
                                                                   <span class="n">z_mem</span><span class="p">))</span>
        <span class="c"># Load the solute (protein or ligand)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Loading and orienting the solute...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_molecule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;solute_filename&#39;</span><span class="p">),</span> <span class="s">&#39;solute&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_solute_sel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;solute&#39;</span><span class="p">])</span>

        <span class="c"># Orient the solute in the X,Y, and optionally Z directions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;solute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orient_solute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;solute&#39;</span><span class="p">])</span>

        <span class="c"># Compute dimensions of the input system</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Computing the size of the input periodic cell...&quot;</span><span class="p">)</span>
        <span class="n">dx_sol</span><span class="p">,</span> <span class="n">dy_sol</span><span class="p">,</span> <span class="n">dx_tm</span><span class="p">,</span> <span class="n">dy_tm</span><span class="p">,</span> <span class="n">dz_full</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_size</span><span class="p">(</span><span class="n">mem_buf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;xy_buf&#39;</span><span class="p">),</span>
                                   <span class="n">wat_buf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wat_buffer&#39;</span><span class="p">),</span>
                                   <span class="n">molid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;solute&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_only</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Solute x diameter is </span><span class="si">%.2f</span><span class="se">\n</span><span class="s">&quot;</span>
                  <span class="s">&quot;</span><span class="se">\t</span><span class="s">Solute y diameter is </span><span class="si">%.2f</span><span class="se">\n</span><span class="s">&quot;</span>
                  <span class="s">&quot;</span><span class="se">\t</span><span class="s">Solute z diameter is </span><span class="si">%.2f</span><span class="s">&quot;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">dx_sol</span><span class="p">,</span> <span class="n">dy_sol</span><span class="p">,</span> <span class="n">dz_full</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Solute x diameter is </span><span class="si">%.2f</span><span class="s"> (</span><span class="si">%.2f</span><span class="s"> in TM region)</span><span class="se">\n</span><span class="s">&quot;</span>
                  <span class="s">&quot;</span><span class="se">\t</span><span class="s">Solute y diameter is </span><span class="si">%.2f</span><span class="s"> (</span><span class="si">%.2f</span><span class="s"> in TM region)</span><span class="se">\n</span><span class="s">&quot;</span>
                  <span class="s">&quot;</span><span class="se">\t</span><span class="s">Solute + membrane Z diameter is </span><span class="si">%.2f</span><span class="s">&quot;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">dx_sol</span><span class="p">,</span> <span class="n">dx_tm</span><span class="p">,</span> <span class="n">dy_sol</span><span class="p">,</span> <span class="n">dy_tm</span><span class="p">,</span> <span class="n">dz_full</span><span class="p">))</span>

        <span class="c"># Compute dimensions of the final system</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Final system will be </span><span class="si">%.2f</span><span class="s"> x </span><span class="si">%.2f</span><span class="s"> x </span><span class="si">%.2f</span><span class="s">&quot;</span>
              <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">X,Y solvent buffer: (</span><span class="si">%4.1f</span><span class="s">, </span><span class="si">%4.1f</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dx_sol</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dy_sol</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_only</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">X,Y transmembrane buffer: (</span><span class="si">%4.1f</span><span class="s">, </span><span class="si">%4.1f</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dx_tm</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dy_tm</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Z solvent buffer: </span><span class="si">%4.1f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">dz_full</span><span class="p">))</span>

        <span class="c"># Tile the membrane/solvent</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Tiling solvent...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;tiled_membrane&#39;</span><span class="p">],</span> <span class="n">times</span> <span class="o">=</span> \
                <span class="n">tile_membrane_patch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;membrane&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                    <span class="n">tmp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span>
                                    <span class="n">allow_z_tile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">water_only</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Solvent tiled </span><span class="si">%d</span><span class="s"> x </span><span class="si">%d</span><span class="s"> x </span><span class="si">%d</span><span class="s"> times&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">times</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="c"># Only delete if a new molecule was created (if tiling occured)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;tiled_membrane&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;membrane&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_molecule</span><span class="p">(</span><span class="s">&#39;membrane&#39;</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Centering solvent...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;tiled_membrane&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">molutils</span><span class="o">.</span><span class="n">center_system</span><span class="p">(</span><span class="n">molid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;tiled_membrane&#39;</span><span class="p">],</span>
                                       <span class="n">tmp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">center_z</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Combine tiled membrane with solute</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Combining solute and tiled solvent patch...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;inserted&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">molutils</span><span class="o">.</span><span class="n">combine_molecules</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;solute&#39;</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;tiled_membrane&#39;</span><span class="p">]],</span>
                                           <span class="n">tmp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_molecule</span><span class="p">(</span><span class="s">&#39;tiled_membrane&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_molecule</span><span class="p">(</span><span class="s">&#39;solute&#39;</span><span class="p">)</span>
        
        <span class="c"># Add more waters if necessary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;combined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_water</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;inserted&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_molecule</span><span class="p">(</span><span class="s">&#39;inserted&#39;</span><span class="p">)</span>

        <span class="c"># Remove atoms outside the final system cell, accounting for boundary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_cell_to_square_prism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;combined&#39;</span><span class="p">])</span>
        <span class="n">box_wat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trim_water</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;combined&#39;</span><span class="p">])</span>

        <span class="c"># Remove lipids outside the box if there are lipids</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_only</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Initial membrane composition:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                  <span class="n">molutils</span><span class="o">.</span><span class="n">print_lipid_composition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">),</span>
                                                   <span class="n">molid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;combined&#39;</span><span class="p">]))</span>

        <span class="c"># Remove atoms that clash with the solvent</span>
        <span class="n">clashes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_overlapping_residues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">),</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;combined&#39;</span><span class="p">],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lipid_friendly_sel&#39;</span><span class="p">))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Removed </span><span class="si">%d</span><span class="s"> extra atoms</span><span class="se">\n</span><span class="s">&quot;</span> 
              <span class="s">&quot;</span><span class="se">\t</span><span class="si">%d</span><span class="s"> out of the box</span><span class="se">\n</span><span class="s">&quot;</span>
              <span class="s">&quot;</span><span class="se">\t</span><span class="si">%d</span><span class="s"> too close to the solute&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="n">box_wat</span><span class="o">+</span><span class="n">clashes</span><span class="p">),</span> <span class="n">box_wat</span><span class="p">,</span>
                                                <span class="n">clashes</span><span class="p">))</span>

        <span class="c"># Remove extra lipids and print info about membrane</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_clashing_lipids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;combined&#39;</span><span class="p">],</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">),</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lipid_friendly_sel&#39;</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Final membrane composition:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                  <span class="n">molutils</span><span class="o">.</span><span class="n">print_lipid_composition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">),</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;combined&#39;</span><span class="p">]))</span>

        <span class="c"># Calculate charge</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Solute net charge: </span><span class="si">%+d</span><span class="se">\n</span><span class="s">&quot;</span>
              <span class="s">&quot;System net charge: </span><span class="si">%+d</span><span class="s">&quot;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">molutils</span><span class="o">.</span><span class="n">get_net_charge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;combined&#39;</span><span class="p">]),</span>
                 <span class="n">molutils</span><span class="o">.</span><span class="n">get_system_net_charge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;combined&#39;</span><span class="p">])))</span>

        <span class="c"># Add ions as necessary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_ions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;salt_conc&#39;</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;cation&#39;</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;combined&#39;</span><span class="p">])</span>

        <span class="c"># System is now built</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;combined&#39;</span><span class="p">]</span>

    <span class="c">#==========================================================================</span>

<div class="viewcode-block" id="DabbleBuilder.write"><a class="viewcode-back" href="../../Dabble.html#Dabble.builder.DabbleBuilder.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the final built system.</span>

<span class="sd">        Args:</span>
<span class="sd">          filename (str): Name of file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fileutils</span><span class="o">.</span><span class="n">check_write_ok</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;output_filename&#39;</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">out_fmt</span><span class="p">,</span>
                                 <span class="n">overwrite</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;overwrite&#39;</span><span class="p">))</span>
        <span class="n">final_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Writing system to </span><span class="si">%s</span><span class="s"> with </span><span class="si">%d</span><span class="s"> atoms comprising:</span><span class="se">\n</span><span class="s">&quot;</span>
              <span class="s">&quot;  </span><span class="si">%d</span><span class="s"> lipid molecules</span><span class="se">\n</span><span class="s">&quot;</span>
              <span class="s">&quot;  </span><span class="si">%d</span><span class="s"> water molecules</span><span class="se">\n</span><span class="s">&quot;</span>
              <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;output_filename&#39;</span><span class="p">),</span>
                 <span class="n">molutils</span><span class="o">.</span><span class="n">num_atoms_remaining</span><span class="p">(</span><span class="n">molid</span><span class="o">=</span><span class="n">final_id</span><span class="p">),</span>
                 <span class="n">molutils</span><span class="o">.</span><span class="n">num_lipids_remaining</span><span class="p">(</span><span class="n">final_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">)),</span>
                 <span class="n">molutils</span><span class="o">.</span><span class="n">num_waters_remaining</span><span class="p">(</span><span class="n">molid</span><span class="o">=</span><span class="n">final_id</span><span class="p">)))</span>
        <span class="n">fileutils</span><span class="o">.</span><span class="n">write_final_system</span><span class="p">(</span><span class="n">out_fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_fmt</span><span class="p">,</span>
                                     <span class="n">out_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;output_filename&#39;</span><span class="p">),</span>
                                     <span class="n">molid</span><span class="o">=</span><span class="n">final_id</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span>
                                     <span class="n">forcefield</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;forcefield&#39;</span><span class="p">),</span>
                                     <span class="n">extra_topos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;extra_topos&#39;</span><span class="p">),</span>
                                     <span class="n">extra_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;extra_params&#39;</span><span class="p">),</span>
                                     <span class="n">extra_streams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;extra_streams&#39;</span><span class="p">),</span>
                                     <span class="n">hmassrepartition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;hmassrepartition&#39;</span><span class="p">))</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">final_id</span><span class="p">)</span>

    <span class="c">#==========================================================================</span>
</div>
<div class="viewcode-block" id="DabbleBuilder.add_molecule"><a class="viewcode-back" href="../../Dabble.html#Dabble.builder.DabbleBuilder.add_molecule">[docs]</a>    <span class="k">def</span> <span class="nf">add_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a molecule file to the system.</span>

<span class="sd">        Args:</span>
<span class="sd">          filename (str): File to load</span>
<span class="sd">          desc (str): Type of molecule: solute, solvent, etc</span>

<span class="sd">        Returns:</span>
<span class="sd">          True if the molecule was successfully added</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">molid</span> <span class="o">=</span> <span class="n">fileutils</span><span class="o">.</span><span class="n">load_solute</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="n">desc</span><span class="p">]</span> <span class="o">=</span> <span class="n">molid</span>
        <span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;beta&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c">#==========================================================================</span>
</div>
<div class="viewcode-block" id="DabbleBuilder.remove_molecule"><a class="viewcode-back" href="../../Dabble.html#Dabble.builder.DabbleBuilder.remove_molecule">[docs]</a>    <span class="k">def</span> <span class="nf">remove_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes a molecule file from the system.</span>

<span class="sd">        Args:</span>
<span class="sd">          desc (str): Key for molecule to remove</span>

<span class="sd">        Returns:</span>
<span class="sd">          true if a molecule was deleted, false otherwise</span>

<span class="sd">        Raises:</span>
<span class="sd">          KeyError if there is no molecule with that key string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">molid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="n">desc</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">molid</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c">#==========================================================================</span>
</div>
<div class="viewcode-block" id="DabbleBuilder.convert_ions"><a class="viewcode-back" href="../../Dabble.html#Dabble.builder.DabbleBuilder.convert_ions">[docs]</a>    <span class="k">def</span> <span class="nf">convert_ions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">salt_conc</span><span class="p">,</span> <span class="n">cation</span><span class="p">,</span> <span class="n">molid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the charge of the molecule and adds salt ions to get the</span>
<span class="sd">        desired concentration by converting water molecules to salt</span>

<span class="sd">        Args:</span>
<span class="sd">          salt_conc (float): Desired salt concentration in M</span>
<span class="sd">          cation (str): Cation to add, either Na or K</span>
<span class="sd">          molid (int): VMD molecule id to consider</span>

<span class="sd">        Returns:</span>
<span class="sd">          (int) number of ions added</span>

<span class="sd">        Raises:</span>
<span class="sd">          ValueError if invalid cation is specified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Check cation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;cation&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Na&#39;</span><span class="p">,</span> <span class="s">&#39;K&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid cation&quot;</span><span class="p">)</span>

        <span class="c"># Give existing cations correct nomenclature</span>
        <span class="n">molutils</span><span class="o">.</span><span class="n">set_cations</span><span class="p">(</span><span class="n">molid</span><span class="p">,</span> <span class="n">cation</span><span class="p">)</span>

        <span class="c"># Calculate number of salt ions needed</span>
        <span class="n">pos_ions_needed</span><span class="p">,</span> <span class="n">neg_ions_needed</span><span class="p">,</span> <span class="n">num_wat</span><span class="p">,</span> <span class="n">total_cations</span><span class="p">,</span> <span class="n">total_anions</span><span class="p">,</span> \
        <span class="n">cation_conc</span><span class="p">,</span> <span class="n">anion_conc</span> <span class="o">=</span> <span class="n">molutils</span><span class="o">.</span><span class="n">get_num_salt_ions_needed</span><span class="p">(</span><span class="n">molid</span><span class="p">,</span>
                                                                    <span class="n">salt_conc</span><span class="p">,</span>
                                                                    <span class="n">cation</span><span class="o">=</span><span class="n">cation</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Solvent will be </span><span class="si">%d</span><span class="s"> waters, </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s"> (</span><span class="si">%.3f</span><span class="s"> M), </span><span class="si">%d</span><span class="s"> Cl (</span><span class="si">%.3f</span><span class="s"> M)&quot;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">num_wat</span><span class="p">,</span> <span class="n">total_cations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;cation&#39;</span><span class="p">),</span> <span class="n">cation_conc</span><span class="p">,</span>
               <span class="n">total_anions</span><span class="p">,</span> <span class="n">anion_conc</span><span class="p">))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Converting </span><span class="si">%d</span><span class="s"> waters to </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s"> ions and </span><span class="si">%d</span><span class="s"> Cl ions...&quot;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">pos_ions_needed</span> <span class="o">+</span> <span class="n">neg_ions_needed</span><span class="p">,</span>
               <span class="n">pos_ions_needed</span><span class="p">,</span> <span class="n">cation</span><span class="p">,</span> <span class="n">neg_ions_needed</span><span class="p">))</span>

        <span class="c"># Add the ions</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">pos_ions_needed</span><span class="p">):</span>
            <span class="n">add_salt_ion</span><span class="p">(</span><span class="n">cation</span><span class="p">,</span> <span class="n">molid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">neg_ions_needed</span><span class="p">):</span>
            <span class="n">add_salt_ion</span><span class="p">(</span><span class="s">&#39;Cl&#39;</span><span class="p">,</span> <span class="n">molid</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pos_ions_needed</span> <span class="o">+</span> <span class="n">neg_ions_needed</span>

    <span class="c">#==========================================================================</span>
</div>
<div class="viewcode-block" id="DabbleBuilder.get_cell_size"><a class="viewcode-back" href="../../Dabble.html#Dabble.builder.DabbleBuilder.get_cell_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">mem_buf</span><span class="p">,</span> <span class="n">wat_buf</span><span class="p">,</span>
                      <span class="n">molid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">zh_mem_full</span><span class="o">=</span><span class="n">_MEMBRANE_FULL_THICKNESS</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                      <span class="n">zh_mem_hyd</span><span class="o">=</span><span class="n">_MEMBRANE_HYDROPHOBIC_THICKNESS</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the cell size of the final system given initial system and</span>
<span class="sd">        buffers. Detects whether or not a membrane is present. Sets the</span>
<span class="sd">        size of the system.</span>

<span class="sd">        Args:</span>
<span class="sd">          mem_buf (float) : Membrane (xy) buffer amount</span>
<span class="sd">          wat_buf (float) : Water (z) buffer amount</span>
<span class="sd">          molid (int) : VMD molecule ID to consider (can&#39;t use with filename)</span>
<span class="sd">          filename (str) : Filename of system to consider (can&#39;t use w molid)</span>
<span class="sd">          zh_mem_full (float) : Membrane thickness</span>
<span class="sd">          zh_mem_hyd (float) : Membrane hydrophobic region thickness</span>

<span class="sd">        Returns:</span>
<span class="sd">        return dx_sol, dy_sol, dx_tm, dy_tm, dz_full</span>
<span class="sd">          (float tuple): x solute dimension, y solute dimension,</span>
<span class="sd">            TM x solute dimension, TM y solute dimension, solute z dimension</span>

<span class="sd">        Raises:</span>
<span class="sd">          ValueError: if filename and molid are both specified</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Sanity check</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">molid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Specified molid and filename to get_cell_size&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">get_top</span><span class="p">()</span>
            <span class="n">molid</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;mae&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">molid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">molid</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">get_top</span><span class="p">()</span>

        <span class="c"># Some options different for water-only systems (no lipid)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_only</span><span class="p">:</span>
            <span class="n">solute_z</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">)</span>
            <span class="n">dx_tm</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">dy_tm</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">sol_solute</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="n">molid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solute_z</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">)</span>
            <span class="n">tm_solute</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;(</span><span class="si">%s</span><span class="s">) and z &gt; </span><span class="si">%f</span><span class="s"> and z &lt; </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span>
                                                                <span class="o">-</span><span class="n">zh_mem_hyd</span><span class="p">,</span>
                                                                <span class="n">zh_mem_hyd</span><span class="p">),</span> <span class="n">molid</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tm_solute</span><span class="p">):</span>
                <span class="n">dx_tm</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tm_solute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">tm_solute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">))</span>
                <span class="n">dy_tm</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tm_solute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">tm_solute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dx_tm</span> <span class="o">=</span> <span class="n">dy_tm</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">sol_solute</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;(</span><span class="si">%s</span><span class="s">) and (z &lt; </span><span class="si">%f</span><span class="s"> or z &gt; </span><span class="si">%f</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span>
                                                                  <span class="o">-</span><span class="n">zh_mem_hyd</span><span class="p">,</span>
                                                                  <span class="n">zh_mem_hyd</span><span class="p">),</span> <span class="n">molid</span><span class="p">)</span>

        <span class="c"># Solvent invariant options</span>
        <span class="n">dx_sol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sol_solute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">sol_solute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">))</span>
        <span class="n">dy_sol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sol_solute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">sol_solute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_x&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;user_x&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dx_tm</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">mem_buf</span><span class="p">,</span> <span class="n">dx_sol</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">wat_buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_y&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;user_y&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dy_tm</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">mem_buf</span><span class="p">,</span> <span class="n">dy_sol</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">wat_buf</span><span class="p">)</span>

        <span class="c"># Z dimension. If there&#39;s a membrane, need to account for asymmetry</span>
        <span class="c"># in the Z dimension where the protein could be uneven in the membrane</span>
        <span class="c"># or even peripheral</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_z&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;user_z&#39;</span><span class="p">]</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;user_z&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">solute_z</span><span class="p">)</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">solute_z</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">solute_z</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">solute_z</span><span class="p">)</span> <span class="o">-</span> <span class="n">buf</span>
            <span class="k">if</span> <span class="n">zh_mem_full</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmax</span> <span class="ow">or</span> <span class="o">-</span><span class="n">zh_mem_full</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmin</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Specified user z of </span><span class="si">%f</span><span class="s"> is too small to &quot;</span>
                                 <span class="s">&quot;accomodate protein and membrane!&quot;</span>
                                 <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;user_z&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_only</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_zmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">solute_z</span><span class="p">)</span> <span class="o">+</span> <span class="n">wat_buf</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_zmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">solute_z</span><span class="p">)</span> <span class="o">-</span> <span class="n">wat_buf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_zmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">solute_z</span><span class="p">)</span><span class="o">+</span><span class="n">wat_buf</span><span class="p">,</span> <span class="n">zh_mem_full</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_zmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">solute_z</span><span class="p">)</span><span class="o">-</span><span class="n">wat_buf</span><span class="p">,</span> <span class="o">-</span><span class="n">zh_mem_full</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmin</span>

        <span class="c"># Cleanup temporary file, if read in</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">molid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">top</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">molecule</span><span class="o">.</span><span class="n">set_top</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dx_sol</span><span class="p">,</span> <span class="n">dy_sol</span><span class="p">,</span> <span class="n">dx_tm</span><span class="p">,</span> <span class="n">dy_tm</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">solute_z</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">solute_z</span><span class="p">)</span>

    <span class="c">#==========================================================================</span>
    <span class="c">#                            Private methods                              #</span>
    <span class="c">#==========================================================================</span>
</div>
    <span class="k">def</span> <span class="nf">_set_solute_sel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the list of resids uniquely corresponding to the in the system</span>
<span class="sd">        and sets the value of the solute_sel attribute.</span>
<span class="sd">        Does this separately by chain since sometimes resids can be the</span>
<span class="sd">        same across different chains. This selection can be used to pull out</span>
<span class="sd">        the solute once other things are added later.</span>
<span class="sd">        This assumes that the solute is the only thing in the system right now.</span>

<span class="sd">        Args:</span>
<span class="sd">          molid (int) : VMD molecule ID to get the selection from</span>

<span class="sd">        Returns:</span>
<span class="sd">          (str) : VMD atom selection for these residues</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Temporary fix for chain W in input file</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;chain W&#39;</span><span class="p">)):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING: Renaming crystal water chain to X, temporary bugfix&quot;</span><span class="p">)</span>
            <span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;chain W&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;chain&#39;</span><span class="p">,</span> <span class="s">&#39;X&#39;</span><span class="p">)</span>
        <span class="n">chains</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;chain&#39;</span><span class="p">))</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">chains</span><span class="p">):</span>
            <span class="n">chn</span> <span class="o">=</span> <span class="n">chains</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="c"># have to handle first separately because of or</span>
            <span class="n">sel</span> <span class="o">+=</span> <span class="s">&quot;(chain </span><span class="si">%s</span><span class="s"> and resid &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chn</span><span class="p">)</span> <span class="o">+</span> \
                   <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> \
                       <span class="nb">set</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;chain </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">chn</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resid&#39;</span><span class="p">))])</span> <span class="o">+</span> \
                   <span class="s">&quot;)&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chains</span><span class="p">):</span>
                <span class="n">sel</span> <span class="o">+=</span> <span class="s">&quot; or &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span> <span class="o">=</span> <span class="n">sel</span>
        <span class="k">return</span> <span class="n">sel</span>

        <span class="c">#==========================================================================</span>

    <span class="k">def</span> <span class="nf">_set_cell_to_square_prism</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the periodic box to be a square prism of specified dimension</span>

<span class="sd">        Args:</span>
<span class="sd">          molid (int): VMD molecule ID to consider</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_top</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">get_top</span><span class="p">()</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">set_top</span><span class="p">(</span><span class="n">molid</span><span class="p">)</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">set_periodic</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                              <span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">)</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">set_top</span><span class="p">(</span><span class="n">old_top</span><span class="p">)</span>

    <span class="c">#==========================================================================</span>

    <span class="k">def</span> <span class="nf">_remove_z_residues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes residues in the +-Z direction in the system. Used to chop off</span>
<span class="sd">        extra waters away from the protein to keep the system the desired</span>
<span class="sd">        size. Changes apparent on next write.</span>

<span class="sd">        Args:</span>
<span class="sd">          molid (int): VMD molecule id to use</span>

<span class="sd">        Returns:</span>
<span class="sd">          (int) number of atoms deleted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_remove_residues</span><span class="p">(</span><span class="s">&#39;(not (</span><span class="si">%s</span><span class="s">)) and noh and abs(z) &gt; </span><span class="si">%f</span><span class="s">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
                                <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>

    <span class="c">#==========================================================================</span>

    <span class="k">def</span> <span class="nf">_add_water</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds water residues in the +- Z direction in the system. Used if there</span>
<span class="sd">        are not enough waters in the initial membrane system. Creates a new</span>
<span class="sd">        molecule with waters added.</span>

<span class="sd">        Args:</span>
<span class="sd">            molid (int): VMD molecule id to use</span>

<span class="sd">        Returns:</span>
<span class="sd">            (int) VMD molecule id with water added</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError if water buffer is None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wat_buffer&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Water buffer undefined&quot;</span><span class="p">)</span>

        <span class="c"># Check the +Z direction</span>
        <span class="n">zup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;wat_buffer&#39;</span><span class="p">]</span> <span class="o">+</span> \
              <span class="nb">max</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">))</span> <span class="o">-</span> \
              <span class="nb">max</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="s">&quot;not (</span><span class="si">%s</span><span class="s"> or </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">))</span>
        <span class="c"># Check the -Z direction</span>
        <span class="n">zdo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;wat_buffer&#39;</span><span class="p">]</span> <span class="o">+</span> \
              <span class="nb">min</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="s">&quot;not (</span><span class="si">%s</span><span class="s"> or </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">))</span> \
              <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">))</span>

        <span class="c"># Load water</span>
        <span class="n">wat_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;membrane_system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> \
                <span class="s">&quot;lipid_membranes/tip3pbox.mae&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_molecule</span><span class="p">(</span><span class="n">wat_path</span><span class="p">,</span> <span class="s">&#39;water&#39;</span><span class="p">)</span>
        <span class="n">to_combine</span> <span class="o">=</span> <span class="p">[</span><span class="n">molid</span><span class="p">]</span>

        <span class="c"># Handle adding water above the protein</span>
        <span class="c"># When moving add a 0.5 less so there isn&#39;t a gap</span>
        <span class="k">if</span> <span class="n">zup</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Adding </span><span class="si">%f</span><span class="s"> A water above the solute...&quot;</span> <span class="o">%</span> <span class="n">zup</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;wtmp&#39;</span><span class="p">],</span> <span class="n">tiletimes</span> <span class="o">=</span> <span class="n">tile_membrane_patch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;water&#39;</span><span class="p">],</span>
                                                                 <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zup</span><span class="p">],</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">allow_z_tile</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">move</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="s">&quot;not (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">))</span> <span class="o">-</span> \
                    <span class="nb">min</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="n">molid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;wtmp&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.5</span>
            <span class="n">atomsel</span><span class="p">(</span><span class="n">molid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;wtmp&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">moveby</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">move</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;wats_up&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">molutils</span><span class="o">.</span><span class="n">center_system</span><span class="p">(</span><span class="n">molid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;wtmp&#39;</span><span class="p">],</span>
                                                            <span class="n">tmp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span>
                                                            <span class="n">center_z</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_molecule</span><span class="p">(</span><span class="s">&#39;wtmp&#39;</span><span class="p">)</span>
            <span class="n">to_combine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;wats_up&#39;</span><span class="p">])</span>

        <span class="c"># Handle adding water below the protein</span>
        <span class="c"># When moving add a 0.5 less so there isn&#39;t a gap</span>
        <span class="k">if</span> <span class="n">zdo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Adding </span><span class="si">%f</span><span class="s"> A water below the solute...&quot;</span> <span class="o">%</span> <span class="n">zdo</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;wtmp&#39;</span><span class="p">],</span> <span class="n">tiletimes</span> <span class="o">=</span> \
                    <span class="n">tile_membrane_patch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;water&#39;</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zdo</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">allow_z_tile</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">move</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="s">&quot;not (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">))</span> <span class="o">-</span> \
                    <span class="nb">max</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="n">molid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;wtmp&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span>
            <span class="n">atomsel</span><span class="p">(</span><span class="n">molid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;wtmp&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">moveby</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">move</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;wats_down&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">molutils</span><span class="o">.</span><span class="n">center_system</span><span class="p">(</span><span class="n">molid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;wtmp&#39;</span><span class="p">],</span>
                                                              <span class="n">tmp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span>
                                                              <span class="n">center_z</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_molecule</span><span class="p">(</span><span class="s">&#39;wtmp&#39;</span><span class="p">)</span>
            <span class="n">to_combine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molids</span><span class="p">[</span><span class="s">&#39;wats_down&#39;</span><span class="p">])</span>

        <span class="c"># Combine and return a new molecule</span>
        <span class="n">newid</span> <span class="o">=</span> <span class="n">molutils</span><span class="o">.</span><span class="n">combine_molecules</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="n">to_combine</span><span class="p">,</span>
                                           <span class="n">tmp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_molecule</span><span class="p">(</span><span class="s">&#39;water&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newid</span>

    <span class="c">#==========================================================================</span>

    <span class="k">def</span> <span class="nf">_trim_water</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes water residues in the +- Z direction in the system. Used</span>
<span class="sd">        to chop off extra waters from the protein that are past a certain cutoff</span>
<span class="sd">        distance. Changes are apparent on next write.</span>

<span class="sd">        Args:</span>
<span class="sd">          molid (int): VMD molecule id to use</span>

<span class="sd">        Returns:</span>
<span class="sd">          int Number of atoms deleted </span>

<span class="sd">        Raises:</span>
<span class="sd">          ValueError if water buffer is None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wat_buffer&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Water buffer undefined&quot;</span><span class="p">)</span>

        <span class="c"># Remove waters in the Z direction</span>
        <span class="c"># Check if we are trimming to absolute size and set z buf if so</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">zcoord</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">_remove_residues</span><span class="p">(</span><span class="s">&#39;(not (</span><span class="si">%s</span><span class="s">) and not (</span><span class="si">%s</span><span class="s">)) and noh and z &gt; </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> \
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_zmax</span><span class="p">),</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">_remove_residues</span><span class="p">(</span><span class="s">&#39;(not (</span><span class="si">%s</span><span class="s">) and not (</span><span class="si">%s</span><span class="s">)) and noh and z &lt; </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">],</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_zmin</span><span class="p">),</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>

        <span class="c"># Trim in the XY direction if it&#39;s a pure water system</span>
        <span class="c"># lipid trimming is done in trim_xy_residues and takes into account</span>
        <span class="c"># lipid center, etc.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_only</span><span class="p">:</span>
            <span class="n">xcoord</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">xcoord</span><span class="p">)</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">xcoord</span><span class="p">))</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">_remove_residues</span><span class="p">(</span><span class="s">&#39;(not (</span><span class="si">%s</span><span class="s">)) and noh and x &gt; </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span>
                                       <span class="nb">max</span><span class="p">(</span><span class="n">xcoord</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">),</span>
                                       <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">_remove_residues</span><span class="p">(</span><span class="s">&#39;(not (</span><span class="si">%s</span><span class="s">)) and noh and x &lt; </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span>
                                       <span class="nb">min</span><span class="p">(</span><span class="n">xcoord</span><span class="p">)</span> <span class="o">-</span> <span class="n">buf</span><span class="p">),</span>
                                      <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>

            <span class="n">ycoord</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">ycoord</span><span class="p">)</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">ycoord</span><span class="p">))</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">_remove_residues</span><span class="p">(</span><span class="s">&#39;(not (</span><span class="si">%s</span><span class="s">)) and noh and y &gt; </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span>
                                       <span class="nb">max</span><span class="p">(</span><span class="n">ycoord</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">),</span>
                                      <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">_remove_residues</span><span class="p">(</span><span class="s">&#39;(not (</span><span class="si">%s</span><span class="s">)) and noh and y &lt; </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span>
                                       <span class="nb">min</span><span class="p">(</span><span class="n">ycoord</span><span class="p">)</span> <span class="o">-</span> <span class="n">buf</span><span class="p">),</span>
                                      <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">total</span>

    <span class="c">#==========================================================================</span>

    <span class="k">def</span> <span class="nf">_remove_xy_lipids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes residues in the +-XY direction in the system. Used to chop off</span>
<span class="sd">        lipids that are protruding outside of the box dimensions.</span>

<span class="sd">        Args:</span>
<span class="sd">          molid (int): VMD molecule id to use</span>

<span class="sd">        Returns:</span>
<span class="sd">          (int) number of atoms deleted</span>

<span class="sd">        Raises:</span>
<span class="sd">          ValueError if the &#39;lipid&#39; only contains hydrogens</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Select residues that are outside the box</span>
        <span class="n">half_x_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">half_y_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">box_sel_str</span> <span class="o">=</span> <span class="s">&#39;abs(x) &gt; </span><span class="si">%f</span><span class="s"> or abs(y) &gt; </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">half_x_size</span><span class="p">,</span> <span class="n">half_y_size</span><span class="p">)</span>

        <span class="c"># Identify lipids that have some part outside of the box</span>
        <span class="n">suspicious_lipid_residues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;(</span><span class="si">%s</span><span class="s">) and (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> \
               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">],</span> <span class="n">box_sel_str</span><span class="p">),</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;residue&#39;</span><span class="p">)))</span>
        <span class="n">bad_lipids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Delete lipids whose center is too far out of the box, keep others</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">suspicious_lipid_residues</span><span class="p">:</span>
            <span class="n">lipid_center</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;noh and residue </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                   <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">()</span>
            <span class="c"># Sanity check</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">lipid_center</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No heavy atoms found in suspicious residue </span><span class="si">%s</span><span class="s">&quot;</span>
                                 <span class="s">&quot;Check your input file.&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lipid_center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">half_x_size</span> <span class="ow">or</span> \
               <span class="nb">abs</span><span class="p">(</span><span class="n">lipid_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">half_y_size</span><span class="p">:</span>
                <span class="n">bad_lipids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">lipid_headgroup_sel</span> <span class="o">=</span> <span class="s">&#39;residue &#39;</span> <span class="o">+</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">bad_lipids</span><span class="p">])</span>

        <span class="c"># Do the deletion</span>
        <span class="n">removal_sel_str</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">) or not (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lipid_headgroup_sel</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;lipid_sel&#39;</span><span class="p">])</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">_remove_residues</span><span class="p">(</span><span class="s">&#39;noh and (</span><span class="si">%s</span><span class="s">) and (</span><span class="si">%s</span><span class="s">) and not (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">box_sel_str</span><span class="p">,</span>
                                  <span class="n">removal_sel_str</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">),</span>
                                 <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total</span>

    <span class="c">#==========================================================================</span>

    <span class="k">def</span> <span class="nf">_remove_overlapping_residues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                     <span class="n">lipid_sel</span><span class="p">,</span>
                                     <span class="n">molid</span><span class="p">,</span>
                                     <span class="n">lipid_friendly_sel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                     <span class="n">dist</span><span class="o">=</span><span class="mf">1.75</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes residues that are overlapping. For example, when the protein</span>
<span class="sd">        system is combined with the membrane, remove the lipids that are now in</span>
<span class="sd">        the same place as the protein. Changes will be written on next call</span>
<span class="sd">        to write to file.</span>

<span class="sd">        Args:</span>
<span class="sd">          lipid_sel (str): VMD atom selection for the lipids</span>
<span class="sd">          molid (int): VMD molecule to remove from</span>
<span class="sd">          lipid_friendly_sel (str): VMD atom selection for lipids that are</span>
<span class="sd">            allowed to be much closer to the protein, or None</span>
<span class="sd">          dist (float): Minimum distance between atoms, defaults to 1.75 A</span>

<span class="sd">        Returns:</span>
<span class="sd">          (int) number of atoms removed due to clashes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Select and remove solvent molecules that are clashing</span>
        <span class="n">clashing_sel</span> <span class="o">=</span> <span class="s">&#39;not (</span><span class="si">%s</span><span class="s">) and noh and not (</span><span class="si">%s</span><span class="s">) and &#39;</span> \
        <span class="s">&#39;(pbwithin </span><span class="si">%f</span><span class="s"> of (noh and (</span><span class="si">%s</span><span class="s">)))&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lipid_sel</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">_remove_residues</span><span class="p">(</span><span class="n">clashing_sel</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>

        <span class="c"># Select and remove lipid molecules that are clashing</span>
        <span class="k">if</span> <span class="n">lipid_friendly_sel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">clashing_sel_lipid</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">) and noh and not (</span><span class="si">%s</span><span class="s">) and &#39;</span> \
            <span class="s">&#39;pbwithin </span><span class="si">%f</span><span class="s"> of (noh and (</span><span class="si">%s</span><span class="s">) and not (</span><span class="si">%s</span><span class="s">))&#39;</span> \
                    <span class="o">%</span> <span class="p">(</span><span class="n">lipid_sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span>
                       <span class="n">lipid_friendly_sel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clashing_sel_lipid</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">) and noh and not (</span><span class="si">%s</span><span class="s">) and &#39;</span> \
            <span class="s">&#39;pbwithin </span><span class="si">%f</span><span class="s"> of (noh and (</span><span class="si">%s</span><span class="s">))&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lipid_sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span>
                                               <span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">_remove_residues</span><span class="p">(</span><span class="n">clashing_sel_lipid</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total</span>

    <span class="c">#==========================================================================</span>

    <span class="k">def</span> <span class="nf">_remove_lipids_near_rings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                  <span class="n">lipid_sel</span><span class="p">,</span>
                                  <span class="n">molid</span><span class="p">,</span>
                                  <span class="n">ring_sel</span><span class="o">=</span><span class="s">&#39;noh and resname HID HIE HIP &#39;</span>
                                           <span class="s">&#39;HIS PHE TRP TYR and not backbone&#39;</span><span class="p">,</span>
                                  <span class="n">dist</span><span class="o">=</span><span class="mf">1.75</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes lipids that could stick through protein rings. Changes</span>
<span class="sd">        will be written on the next call to write to a file</span>

<span class="sd">        Args:</span>
<span class="sd">          lipid_sel (str): VMD atom selection for the lipids</span>
<span class="sd">          molid (int): VMD molecule id to look at</span>
<span class="sd">          ring_sel (str): VMD atom selection for ring amino acids to check</span>
<span class="sd">          dist (float): Minimum distance between atoms, defaults to 1.75 A</span>

<span class="sd">        Returns:</span>
<span class="sd">          (int) number of atoms removed due to sticking through rings</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">solute_ring_sel</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">) and (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span> <span class="n">ring_sel</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_remove_residues</span><span class="p">(</span><span class="s">&#39;noh and (</span><span class="si">%s</span><span class="s">) and not (</span><span class="si">%s</span><span class="s">) and &#39;</span>
                                <span class="s">&#39;pbwithin </span><span class="si">%f</span><span class="s"> of (noh and (</span><span class="si">%s</span><span class="s">))&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">lipid_sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_sel</span><span class="p">,</span>
                                   <span class="n">dist</span><span class="p">,</span> <span class="n">solute_ring_sel</span><span class="p">),</span>
                                <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>

    <span class="c">#==========================================================================</span>

    <span class="k">def</span> <span class="nf">_remove_lipid_boundary_clash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pointy_type</span><span class="p">,</span> <span class="n">ring_type</span><span class="p">,</span> <span class="c"># pylint: disable=no-self-use</span>
                                     <span class="n">molid</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes lipids that are too close to other lipids at the periodic</span>
<span class="sd">        boundary</span>

<span class="sd">        Args:</span>
<span class="sd">    /     pointy_type (str): VMD atom selection for pointy type</span>
<span class="sd">          ring_type (str): VMD atom selection for ring type</span>
<span class="sd">          molid (int): VMD molecule id to look at</span>
<span class="sd">          dist (float): Minimum distance between atoms, defaults to 1.0 A</span>

<span class="sd">        Returns:</span>
<span class="sd">          (int) number of atoms removed due to boundary clash</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: arent these selections just the same?</span>
        <span class="n">sel1</span> <span class="o">=</span> <span class="s">&#39;noh and (</span><span class="si">%s</span><span class="s">) and pbwithin </span><span class="si">%f</span><span class="s"> of noh and (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pointy_type</span><span class="p">,</span>
                                                                 <span class="n">dist</span><span class="p">,</span>
                                                                 <span class="n">ring_type</span><span class="p">)</span>
        <span class="n">sel2</span> <span class="o">=</span> <span class="s">&#39;noh and (</span><span class="si">%s</span><span class="s">) and pbwithin </span><span class="si">%f</span><span class="s"> of noh and (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ring_type</span><span class="p">,</span>
                                                                 <span class="n">dist</span><span class="p">,</span>
                                                                 <span class="n">pointy_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_remove_residues</span><span class="p">(</span><span class="s">&#39;(</span><span class="si">%s</span><span class="s">) or (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sel1</span><span class="p">,</span> <span class="n">sel2</span><span class="p">),</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>

    <span class="c">#==========================================================================</span>

    <span class="k">def</span> <span class="nf">_remove_clashing_lipids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molid</span><span class="p">,</span> <span class="n">lipid_sel</span><span class="p">,</span> <span class="n">lipid_friendly_sel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes all types of clashing lipids in a given molecule</span>

<span class="sd">        Args:</span>
<span class="sd">          molid (int): VMD molecule id to look at</span>
<span class="sd">          lipid_sel (str): VMD atom selection for lipids</span>

<span class="sd">        Returns:</span>
<span class="sd">          (int) total number of atoms removed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Remove lipids stuck through aromatic rings</span>
        <span class="n">ring_lips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_lipids_near_rings</span><span class="p">(</span><span class="n">lipid_sel</span><span class="p">,</span>
                                                   <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>
        <span class="c"># TODO</span>
        <span class="n">clash_lips</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">protein_lips</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">solute_lips</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;clash_lipids&#39;</span><span class="p">):</span>
            <span class="n">x_edge_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="mf">0.9</span>
            <span class="n">y_edge_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="mf">0.9</span>
            <span class="n">pointy_lipid_sel</span> <span class="o">=</span> <span class="s">&#39;((</span><span class="si">%s</span><span class="s">) and not (</span><span class="si">%s</span><span class="s">)) and (abs(x) &gt; </span><span class="si">%f</span><span class="s"> or &#39;</span> \
            <span class="s">&#39;abs(y) &gt; </span><span class="si">%f</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lipid_sel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;clash_lipids&#39;</span><span class="p">],</span>
                              <span class="n">x_edge_dim</span><span class="p">,</span> <span class="n">y_edge_dim</span><span class="p">)</span>
            <span class="n">ring_lipid_sel</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> and (abs(x) &gt; </span><span class="si">%f</span><span class="s"> or abs(y) &gt; </span><span class="si">%f</span><span class="s">)&#39;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;clash_lipids&#39;</span><span class="p">],</span> <span class="n">x_edge_dim</span><span class="p">,</span> <span class="n">y_edge_dim</span><span class="p">)</span>
            <span class="n">clash_lips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_lipid_boundary_clash</span><span class="p">(</span><span class="n">pointy_lipid_sel</span><span class="p">,</span>
                                                           <span class="n">ring_lipid_sel</span><span class="p">,</span>
                                                           <span class="n">molid</span><span class="p">)</span>
            <span class="c">#TODO replace with its own thing not near rings</span>
            <span class="n">protein_lips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_lipids_near_rings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;clash_lipids&#39;</span><span class="p">],</span> \
                <span class="n">ring_sel</span><span class="o">=</span><span class="s">&#39;noh and protein and not backbone&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> \
                <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>

        <span class="n">solute_lips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_xy_lipids</span><span class="p">(</span><span class="n">molid</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Removed </span><span class="si">%d</span><span class="s"> atoms&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">solute_lips</span> <span class="o">+</span> <span class="n">ring_lips</span> <span class="o">+</span> <span class="n">clash_lips</span> <span class="o">+</span>
                                    <span class="n">protein_lips</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;  </span><span class="si">%4d</span><span class="s"> atoms from lipids running into the solute</span><span class="se">\n</span><span class="s">&quot;</span>
              <span class="s">&quot;  </span><span class="si">%4d</span><span class="s"> atoms from lipids going through HIS, PHE, TYR, TRP</span><span class="se">\n</span><span class="s">&quot;</span>
              <span class="s">&quot;  </span><span class="si">%4d</span><span class="s"> atoms from one lipid going through another</span><span class="se">\n</span><span class="s">&quot;</span>
              <span class="s">&quot;  </span><span class="si">%4d</span><span class="s"> atoms from lipids getting stuck in a sidechain&quot;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">solute_lips</span><span class="p">,</span> <span class="n">ring_lips</span><span class="p">,</span> <span class="n">clash_lips</span><span class="p">,</span> <span class="n">protein_lips</span><span class="p">))</span>

<span class="c">#==========================================================================</span>

    <span class="k">def</span> <span class="nf">_orient_solute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Orients the solute. Can either move it explicitly in the z direction,</span>
<span class="sd">        or align to an OPM structure.</span>

<span class="sd">        Args:</span>
<span class="sd">          molid (int): VMD molecule ID to orient</span>
<span class="sd">          z_move (float): Amount to move in the Z direction</span>
<span class="sd">          z_rotation (float): Amount to rotate membrane relative to protein,</span>
<span class="sd">            can just take this straight from the OPM website value</span>
<span class="sd">          opm_pdb (str): Filename of OPM structure to align to</span>
<span class="sd">          opm_align (str): Atom selection string to align</span>
<span class="sd">          tmp_dir (str): Directory to put temporary files in</span>

<span class="sd">        Returns:</span>
<span class="sd">          (int) VMD molecule ID of oriented system</span>

<span class="sd">        Raises:</span>
<span class="sd">          ValueError if movement and alignment arguments are both specified</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c"># Check that OPM and alignment aren&#39;t both specified</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;opm_pdb&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z_move&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z_rotation&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;ERROR: Cannot specify an OPM pdb and manual orientation information&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;opm_pdb&#39;</span><span class="p">):</span>
            <span class="n">opm</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;pdb&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;opm_pdb&#39;</span><span class="p">])</span>
            <span class="n">moveby</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;protein and backbone&#39;</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> \
                             <span class="n">atomsel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;opm_align&#39;</span><span class="p">),</span> <span class="n">molid</span><span class="o">=</span><span class="n">opm</span><span class="p">))</span>
            <span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">moveby</span><span class="p">)</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">opm</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">molid</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z_move&#39;</span><span class="p">):</span>
            <span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span><span class="o">.</span><span class="n">moveby</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;z_move&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z_rotation&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">molid</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;z_rotation&#39;</span><span class="p">):</span>
            <span class="n">trans</span><span class="o">.</span><span class="n">resetview</span><span class="p">(</span><span class="n">molid</span><span class="p">)</span> <span class="c"># View affect rotation matrix, now it&#39;s I</span>
            <span class="c"># This is negative because we want membrane flat along the z-axis,</span>
            <span class="c"># and OPM lists the membrane rotation relative to the protein</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s">&#39;z_rotation&#39;</span><span class="p">])</span>
            <span class="c"># Rotation matrix in row order with 4th dimension just from I</span>
            <span class="c"># pylint: disable=bad-whitespace, bad-continuation</span>
            <span class="n">rotmat</span> <span class="o">=</span> <span class="p">[</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                       <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>   <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                             <span class="mi">0</span>        <span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>          <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                             <span class="mi">0</span>        <span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>          <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span>
            <span class="c"># pylint: enable=bad-whitespace, bad-continuation</span>
            <span class="n">trans</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="n">molid</span><span class="p">,</span> <span class="n">rotmat</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">molid</span>

        <span class="c"># Center the system according to VMD&#39;s internal metric, then</span>
        <span class="c"># move the protein in the xy plane so that there is equal padding</span>
        <span class="c"># on either side</span>
        <span class="n">molid</span> <span class="o">=</span> <span class="n">molutils</span><span class="o">.</span><span class="n">center_system</span><span class="p">(</span><span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tmp_dir&#39;</span><span class="p">),</span>
                                       <span class="n">center_z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">water_only</span><span class="p">)</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)))</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">ty</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)))</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">temp_mae</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.mae&#39;</span><span class="p">,</span>
                                    <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;dabble_centered&#39;</span><span class="p">,</span>
                                    <span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tmp_dir&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">system</span><span class="o">.</span><span class="n">moveby</span><span class="p">((</span><span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">system</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;mae&#39;</span><span class="p">,</span> <span class="n">temp_mae</span><span class="p">)</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">molid</span><span class="p">)</span>
        <span class="n">new_id</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;mae&#39;</span><span class="p">,</span> <span class="n">temp_mae</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_id</span>

<span class="c">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
<span class="c">#                           MODULE FUNCTIONS</span>
<span class="c">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
</div>
<span class="k">def</span> <span class="nf">_find_convertible_water_molecule</span><span class="p">(</span><span class="n">molid</span><span class="p">,</span> <span class="c"># pylint: disable=invalid-name</span>
                                     <span class="n">water_sel</span><span class="o">=</span><span class="s">&#39;resname TIP3&#39;</span><span class="p">,</span>
                                     <span class="n">min_ion_dist</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds a water molecule that can be converted to an ion</span>

<span class="sd">    Args:</span>
<span class="sd">      molid (int): VMD molid to look at</span>
<span class="sd">      water_sel (str): VMD atom selection for water</span>
<span class="sd">      min_ion_dist (float): Minimum distance between ionds</span>

<span class="sd">    Returns:</span>
<span class="sd">      (int) Atom index of a water oxygen that is convertible</span>

<span class="sd">    Raises:</span>
<span class="sd">      ValueError if no convertible water molecules are found</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">inclusion_sel</span> <span class="o">=</span> <span class="s">&#39;beta 1 and noh and (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">water_sel</span>
    <span class="n">exclusion_sel</span> <span class="o">=</span> <span class="s">&#39;beta 1 and not (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">water_sel</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;(</span><span class="si">%s</span><span class="s">) and not pbwithin </span><span class="si">%f</span><span class="s"> of (</span><span class="si">%s</span><span class="s">)&#39;</span> \
                  <span class="o">%</span> <span class="p">(</span><span class="n">inclusion_sel</span><span class="p">,</span> <span class="n">min_ion_dist</span><span class="p">,</span> <span class="n">exclusion_sel</span><span class="p">),</span> <span class="n">molid</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No convertible water molecules found in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sel</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">)[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">))]</span>

<span class="c">#==========================================================================</span>

<span class="k">def</span> <span class="nf">_convert_water_molecule_to_ion</span><span class="p">(</span><span class="n">molid</span><span class="p">,</span> <span class="n">atom_id</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a water molecule to an ion, deleting the hydgrogens and</span>
<span class="sd">    placing the ion where the water oxygen was</span>

<span class="sd">    Args:</span>
<span class="sd">      molid (int): VMD molecule to operate on</span>
<span class="sd">      atom_id (int): Atom index of water oxygen to change to ion</span>
<span class="sd">      element (str in Na, K, Cl): Ion to apply</span>

<span class="sd">    Raises:</span>
<span class="sd">      ValueError: if invalid element specified</span>
<span class="sd">      ValueError: if atom id is not of an oxygen water</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Na&#39;</span><span class="p">,</span> <span class="s">&#39;K&#39;</span><span class="p">,</span> <span class="s">&#39;Cl&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Ion must be Na, K, or Cl. Was &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="p">)</span>

    <span class="n">element_received</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;index </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">atom_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;element&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">element_received</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s">&#39;O&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Received non-water oxygen to convert, id </span><span class="si">%d</span><span class="s"> element </span><span class="si">%s</span><span class="s">&quot;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="n">atom_id</span><span class="p">,</span> <span class="n">element_received</span><span class="p">))</span>

    <span class="n">molutils</span><span class="o">.</span><span class="n">set_ion</span><span class="p">(</span><span class="n">molid</span><span class="p">,</span> <span class="n">atom_id</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
    <span class="n">_remove_atoms</span><span class="p">(</span><span class="s">&#39;element H and same residue as index </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">atom_id</span><span class="p">,</span> <span class="n">molid</span><span class="p">)</span>

<span class="c">#==========================================================================</span>

<span class="k">def</span> <span class="nf">_remove_atoms</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">molid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Marks specified atoms for removal. IMPORTANT - atoms are not actually</span>
<span class="sd">    deleted. Changes will be written on next call to write!</span>

<span class="sd">    Args:</span>
<span class="sd">      sel (str): VMD atom selection string to remove</span>
<span class="sd">      molid (int): VMD molecule ID to consider</span>

<span class="sd">    Returns:</span>
<span class="sd">      (int): The number of atoms removed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">marked</span> <span class="o">=</span> <span class="n">atomsel</span><span class="p">(</span><span class="s">&#39;beta 1 and (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">sel</span><span class="p">,</span> <span class="n">molid</span><span class="o">=</span><span class="n">molid</span><span class="p">)</span>
    <span class="n">marked</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;beta&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">marked</span><span class="p">)</span>

<span class="c">#==========================================================================</span>

<span class="k">def</span> <span class="nf">_remove_residues</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">molid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Marks all residues containing an atom in the selection for deletion.</span>
<span class="sd">    IMPORTANT - atoms are not actually deleted until next call to write!</span>

<span class="sd">    Args:</span>
<span class="sd">      sel (str): VMD atom selection string to remove</span>
<span class="sd">      molid (int): VMD molecule ID to consider</span>

<span class="sd">    Returns:</span>
<span class="sd">      (int): The number of atoms removed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">_remove_atoms</span><span class="p">(</span><span class="s">&#39;same residue as (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">sel</span><span class="p">,</span> <span class="n">molid</span><span class="p">)</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
<span class="c">#                            PUBLIC FUNCTIONS                             #</span>
<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>


<div class="viewcode-block" id="add_salt_ion"><a class="viewcode-back" href="../../Dabble.html#Dabble.builder.add_salt_ion">[docs]</a><span class="k">def</span> <span class="nf">add_salt_ion</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">molid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes a water molecule to a salt ion.</span>

<span class="sd">    Args:</span>
<span class="sd">      element (str): ion to add</span>
<span class="sd">      molid (int): VMD molecule id to consider</span>

<span class="sd">    Raises:</span>
<span class="sd">      AssertionException : if element is not supported</span>

<span class="sd">    Returns:</span>
<span class="sd">      (int) the index of the water molecule that was replaced</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Na&#39;</span><span class="p">,</span> <span class="s">&#39;K&#39;</span><span class="p">,</span> <span class="s">&#39;Cl&#39;</span><span class="p">],</span> <span class="s">&#39;element must be Na, K, or Cl&#39;</span>
    <span class="n">atom_id</span> <span class="o">=</span> <span class="n">_find_convertible_water_molecule</span><span class="p">(</span><span class="n">molid</span><span class="p">)</span>
    <span class="n">_convert_water_molecule_to_ion</span><span class="p">(</span><span class="n">molid</span><span class="p">,</span> <span class="n">atom_id</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">atom_id</span>

<span class="c">#==========================================================================</span>
</div>
<div class="viewcode-block" id="tile_membrane_patch"><a class="viewcode-back" href="../../Dabble.html#Dabble.builder.tile_membrane_patch">[docs]</a><span class="k">def</span> <span class="nf">tile_membrane_patch</span><span class="p">(</span><span class="n">input_id</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">,</span> <span class="n">allow_z_tile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tiles a system in the x and y dimension (z currently unsupported) to</span>
<span class="sd">    make a larger system.</span>

<span class="sd">    Args:</span>
<span class="sd">      input_id (int): VMD molecule id to tile</span>
<span class="sd">      min_size (array of 3 floats): Final system X, Y, Z dimension</span>
<span class="sd">      tmp_dir (str): Directory in which to put tiled molecule</span>
<span class="sd">      allow_z_tile (bool): Whether to allow tiling in the Z direction</span>

<span class="sd">    Returns:</span>
<span class="sd">      (int) output molecule id</span>
<span class="sd">      (int 3x) number of times tiled in x, y, z direction</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mem_dimensions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">molutils</span><span class="o">.</span><span class="n">get_system_dimensions</span><span class="p">(</span><span class="n">molid</span><span class="o">=</span><span class="n">input_id</span><span class="p">))</span>
    <span class="n">times_x</span><span class="p">,</span> <span class="n">times_y</span><span class="p">,</span> <span class="n">times_z</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="k">for</span> <span class="n">times</span> <span class="ow">in</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">min_size</span> <span class="o">/</span> <span class="n">mem_dimensions</span><span class="p">)]</span>

    <span class="c"># Disallow tiling in Z direction</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_z_tile</span><span class="p">:</span>
        <span class="n">times_z</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c"># If there is not enough water in the Z direction, it will be added later</span>

    <span class="k">if</span> <span class="n">times_x</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">times_y</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">times_z</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">output_id</span> <span class="o">=</span> <span class="n">input_id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_id</span> <span class="o">=</span> <span class="n">molutils</span><span class="o">.</span><span class="n">tile_system</span><span class="p">(</span><span class="n">input_id</span><span class="p">,</span> <span class="n">times_x</span><span class="p">,</span> <span class="n">times_y</span><span class="p">,</span> <span class="n">times_z</span><span class="p">,</span>
                                         <span class="n">tmp_dir</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_id</span><span class="p">,</span> <span class="p">(</span><span class="n">times_x</span><span class="p">,</span> <span class="n">times_y</span><span class="p">,</span> <span class="n">times_z</span><span class="p">)</span>

<span class="c">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Robin Betz.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0a1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>